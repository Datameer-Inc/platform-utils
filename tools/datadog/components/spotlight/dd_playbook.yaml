- name: Install Datadog Agent on servers in AWS
  hosts: localhost
  roles:
    - { role: datadog.datadog, become: yes }
  vars:
    datadog_enabled: "{{ lookup('env', 'DD_AGENT_ENABLED') | default('false', true) }}"
    datadog_agent_version: "{{ lookup('env', 'DD_AGENT_VERSION') | default('7.25.0', true) }}"
    datadog_api_key: "{{ lookup('env', 'DD_API_KEY') }}"
    datadog_config:
      tags:
        - "ddenabled:true"
        - "env:dev-steve"
      logs_enabled: true
      process_config:
        enabled: "true"
      network_config:
        enabled: true
    # Drop-ins for /etc/datadog-agent/conf.d/<check_name>.d/conf.yaml
    # See make targets for more details
    datadog_checks:
      disk:
        init_config:
        instances:
          - use_mount: false
            excluded_filesystems:
              - tmpfs
              - shm
            excluded_mountpoint_re: '/var/lib/docker/(devicemapper|overlay).*'
      docker:
        init_config:
        instances:
          collect_events: true
          collect_container_size: true
          collect_images_stats: true
          collect_image_size: true
